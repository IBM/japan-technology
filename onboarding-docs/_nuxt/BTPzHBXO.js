const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CMLDHeq3.js","./Bsy4XOlU.js","./entry.DsHBgv_V.css"])))=>i.map(i=>d[i]);
import{a5 as p}from"./Bsy4XOlU.js";import{i as w,j as d,k as m,l as b}from"./C4d6ro8k.js";import"./C2lumP4s.js";import"./DKJ0mo73.js";import"./30LF49ak.js";import"./D-Sytljn.js";import"./DddxX8eT.js";import"./Cj_BW6Ny.js";import"./sOE2B0QJ.js";import"./Bioz8W5m.js";import"./C0c5eO4-.js";import"./B0Xm9tiF.js";import"./Lgg3mkdH.js";import"./u6zCiLjM.js";import"./B0xtKa7U.js";import"./BJ2ClxiI.js";import"./ABpAZKLD.js";import"./B7Eunqun.js";import"./C-fHSCva.js";import"./RnsC1jSz.js";import"./DhDZgCUH.js";import"./an5hIU4h.js";import"./Btf4yYCp.js";import"./C6Y-ieo6.js";async function h(o,n="gzip"){let e;if(typeof Buffer<"u"){const a=Buffer.from(o,"base64");e=Uint8Array.from(a)}else if(typeof atob<"u")e=Uint8Array.from(atob(o),a=>a.charCodeAt(0));else throw new TypeError("No base64 decoding method available");const r=new Response(new Blob([e])).body?.pipeThrough(new DecompressionStream(n)),c=await new Response(r).text();return JSON.parse(c)}function l(o,n){const e=g(o),t={...n};for(const r in t)e[r]==="json"&&t[r]&&t[r]!=="undefined"&&(t[r]=JSON.parse(t[r])),e[r]==="boolean"&&t[r]!=="undefined"&&(t[r]=!!t[r]);for(const r in t)t[r]==="NULL"&&(t[r]=void 0);return t}function g(o){const n=o.match(/FROM\s+(\w+)/);return n?w[y(n[1])]?.fields||{}:{}}function y(o){return o.replace(/^_content_/,"")}let i;const f=new Map,s=new Map;function H(o){async function n(e){const t=String(e);return i||(s.has("_")||s.set("_",S()),i=await s.get("_"),s.delete("_")),f.has(t)||(s.has(t)||s.set(t,_(e)),await s.get(t),f.set(t,"loaded"),s.delete(t)),i}return{all:async(e,t)=>(await n(o),i.exec({sql:e,bind:t,rowMode:"object",returnValue:"resultRows"}).map(r=>l(e,r))),first:async(e,t)=>(await n(o),l(e,i.exec({sql:e,bind:t,rowMode:"object",returnValue:"resultRows"}).shift())),exec:async(e,t)=>{await n(o),await i.exec({sql:e,bind:t})}}}async function S(){if(!i){const o=await p(()=>import("./CMLDHeq3.js"),__vite__mapDeps([0,1,2]),import.meta.url).then(e=>e.default);globalThis.sqlite3ApiConfig={silent:!0,debug:(...e)=>console.debug(...e),warn:(...e)=>{String(e[0]).includes("OPFS sqlite3_vfs")||console.warn(...e)},error:(...e)=>console.error(...e),log:(...e)=>console.log(...e)};const n=await o();i=new n.oo1.DB}return i}async function _(o){if(window.sessionStorage.getItem("previewToken"))return i;let n=null;const e=`checksum_${o}`,t=`collection_${o}`;let r="matched";try{i.exec({sql:`SELECT * FROM ${d.info} where id = '${e}'`,rowMode:"object",returnValue:"resultRows"}).shift()?.version!==m[String(o)]&&(r="mismatch")}catch{r="missing"}if(r!=="matched"){if(window.localStorage.getItem(`content_${e}`)===m[String(o)]&&(n=window.localStorage.getItem(`content_${t}`)),!n){n=await b(void 0,String(o));try{window.localStorage.setItem(`content_${e}`,m[String(o)]),window.localStorage.setItem(`content_${t}`,n)}catch(a){console.error("Database integrity check failed, rebuilding database",a)}}const c=await h(n);await i.exec({sql:`DROP TABLE IF EXISTS ${d[String(o)]}`}),r==="mismatch"&&await i.exec({sql:`DELETE FROM ${d.info} WHERE id = '${e}'`});for(const a of c)try{await i.exec(a)}catch(u){console.error("Error executing command",u)}}return i}export{H as loadDatabaseAdapter};
