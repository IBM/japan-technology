作業を進めて、2 番目のフローをセットアップします。温湿度センサーを対象としたフローです。

メニューから [Rename (名前変更)] を選択して、フローの名前を「温湿度センサー」に変更し、フローを区別しやすくします。DHT 22 および DHT 11 温湿度センサー・モジュール用の contrib モジュールはインストール済みになっています。該当する DHT ノードを見つけて、フロー内にドロップします。このノードが、未加工の測定値を摂氏の温度とパーセンテージの相対湿度に変換します。このノードはフロー内で機能するように意図されています。センサーの測定値を取得するためには、このノードをトリガーする必要があります。そのためにはタイムスタンプ・ノードを使用します。このノードをフロー内にドロップします。タイムスタンプは特定の間隔でセンサーをトリガーして値を読み取るので、間隔を設定します。間隔として任意の分数または秒数を設定できます。私はデフォルトの 5 分に設定します。このノードをセンサー・モジュールに接続すると、このノードが 5 分間隔でセンサーの値を読み取ります。センサー・ノードを構成して、DHT11 として設定する必要があります。DHT11 が接続されているのは、Raspberry Pi 上のピン 40 です。このノードには「温湿度センサー」という名前を付けます。

温湿度センサーから送られてくる値を確認する際は、構成を調整して、2、3 秒ほどの短い間隔にします。また、デバッグ・ノードをフローに追加します。これによって、センサーの値を読み取るたびに、メッセージ全体がデバッグ・パネルに出力されるようにします。デプロイすると、センサーの測定値がここに表示されます。温度の値がペイロードで、パーセンテージの湿度はメッセージ内の別個のキーに格納されています。間隔を 5 分に戻します。

次は、2 つのホーム・キット・ノードをセットアップします。1 つは温度の測定値用、もう 1 つは湿度の測定値用です。このホーム・キット・ノードを 2 つ、フロー内にドロップします。それぞれのノードを構成します。ノードには新しいアクセサリー・タイプが必要になります。まずは、温度センサーです。必要に応じてカスタム・コードを指定することもできます。アクセサリーのタイプはセンサーとして設定します。名前は「温度センサー」にします。このノードを構成するには、温度サービスを利用することができます。この特定のセンサーに名前を付けます。このセンサーは玄関のドアに取り付けるため、「ドア温度」という名前にします。湿度センサーについても同じ作業を繰り返します。湿度用のアクセサリーをセットアップし、必要に応じてカスタム・コードを指定します。アクセサリーのタイプをセンサーとして設定します。「湿度センサー」という名前を付けます。最後に、湿度サービスとして構成して、名前を付けます。このセンサーも玄関のドアに取り付けるので、「ドア湿度」という名前にします。

フロー内の 2 つのホーム・キット・ノードを構成しました。次に必要なのは、温湿度センサー・ノードからの値を中継することです。これらの値をペイロードから取得して、2 つのホーム・キット・ノードのそれぞれに入力します。それには、いくつかのカスタム関数を使用します。

最初の関数は、温湿度センサー・ノードからメッセージを取得します。(この関数ノードは) 温度の測定値だけを抽出して、メッセージ・ペイロードを設定します。これらのホーム・キット・ノードが期待するキーはすでに調べてあります。このホーム・キット・ノードが期待するキーは「current temperature」です。したがって、メッセージ・ペイロードから直接取得できます。ただし、文字列になっているので、浮動小数点数に変換する必要があります。そこで pos-float を使用します。ノードに名前を付けて、処理しやすくします。この関数ノードの名前は、「温度変換」にします。これで、この関数ノードをホーム・キット・ノードに接続できます。どのような処理が行われているかを確認できるよう、デバッグ・ノードを使って、最後にホーム・キット・ノードから送られてくるメッセージが表示されるようにします。

次は、湿度センサー用の 2 番目の関数が必要です。この関数ノードには「湿度変換」という名前を付けます。このホーム・キット・ノードが期待するキーは、メッセージ・ペイロードに含まれる「current relative humidity」です。メッセージ・ペイロードを設定します。該当するキーを指定します。湿度の値はメッセージから取得するため、この値を文字列ではなく、数値に変換する必要があります。今回は、整数として設定し、メッセージの湿度フィールドから取得します。センサー・メッセージを変換関数に接続して、結果がホーム・キット・ノードに直接入力されるようにします。それをデバッグ・ノードにプッシュして、ホーム・キット・ノードから返される内容を確認できるようにします。

iPhone または iPad 上でホーム・アプリを開くと、湿度センサーと温度センサーが表示されているので、センサーを追加するときに両方とも使用できます。追加するのはセットアップするのと同じくらいに単純なことです。湿度センサーのコードを入力します。これで、湿度センサーが追加されました。ドア・センサーをトリガーします。まだ動いています。フローの構成で 5 分間待たなくても済むようにして、手作業でトリガーすると、61% と表示されます。これとまったく同じ作業を温度センサーで繰り返します。アクセサリーを追加し、温度センサーを追加します。コードを入力します。これで、温度センサーが追加されました。23℃ となっています。






