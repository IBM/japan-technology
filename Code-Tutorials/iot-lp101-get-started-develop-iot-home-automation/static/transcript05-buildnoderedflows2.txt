I'm going to go ahead and set up the second flow now for my temperature and humidity sensor.

I can rename the flow from the menu, to temperature and humidity sensor to make it a little bit easier to distinguish my flows.  So I've already installed a contrib module for  the DHT 22 and DHT 11 temperature and humidity sensor modules. So I'll go and find that DHT node and I'll drop it into my flow.  So this takes care of converting the raw readings into degree Celcius, and into percentage of relative humiditity.  It is designed to work inside of a flow.  So it needs to be triggered in order to get a sensor reading. So what I'm going to do is I'm going to use a timestamp node, so I'll drop in a timestamp that will trigger that sensor to be read at a specific interval, so set it up as an interval, and that could be any number of minutes or seconds. I'm just going to set it to 5 minutes as a default.  So now if I hook that up to my sensor module, it'll read every 5 minutes.  I'll configure this sensor node, so it needs to be DHT11 and it is connected up to pin 40 on the Raspberry Pi. And I'll give it a name, temperature and humidity sensor.

So now if I want to see what values are coming out of that temperature and humidity sensor, I can go and tweak the interval so that it is only a few seconds. And I'll add a debug node to my flow, so that every time that sensor reads, it's going to print that entire message to the debug panel.  So, deploy, and there we go... we can see some sensor readings coming in there.  So the temperature value is the payload and the percentage humidity is stored in a separate key in the message.  So we'll go put that interval back to 5 minutes.  

And now what we want to do is set up two home kit nodes.  One for the temperature reading, and one for the humidity reading.  So I'll drop two of those home kit nodes into the flow.   And I'll configure each one.  They're going to need a new accessory type, so the first one is a temperature sensor, I can give it a custom code if I want, and I'll set it up as a sensor type of accessory, and give it a name, so temperature sensor. And then I can configure that using the temperature service, and give it a name for this specific sensor, so because this one is installed on my front door, I'm going to call it the door temperature.  Then I can do the same thing for the humidity node, so set up an accessory for the humidity, give it a custom code if I want to, set it up as a sensor type of accessory, give it a name, humidity sensor... and then finally configure it as a humidity service, and give it a name, so again it's installed at my door, so it's going to be a door humidity.

So now I have those two home kit nodes in my flow. And what I need to do is hook up the values from the temperature and humidity sensor node, so getting those values out of the payload, and putting them into those two home kit nodes.  So I'm going to use a couple of custom functions to do that.  

The first one is going to take the message from the temperature and humidity sensor node, and it's just going to pull out the temperature reading, so it's going to set the message payload.  And I've already checked which keys these home kit nodes are expecting.  So I know that this one's expecting "current temperature" and so I can get this directly from the message payload.  But because it is a string, I'm going to have to convert it in a floating point number, so I'll use pos-float?. So I'll give that a name just so that it makes it a bit easier to work with; so convert temperature is the name of that function. And then I can hook that up to my home kit node.  And just so that I can see what's going on I'll use the debug node just to see the messages that come out of my home kit nodes at the end.  

So now I'll need a second function for my humidity sensor.  Give it a name, convert humidity.  And this time the message payload that the home kit node is expecting has a key called 'current relative humidity'.  So I'll set that message payload.  I'll give it that key.  And the value for this is coming from the message humidity and again I want to convert this into a number rather than a string, so this time I'll set it as an integer, coming from the message humidity field.  So now I hook up the sensor message to the conversion function, and then the results go straight into my home kit node, and I'll push that into the debug node so that I can see what's coming back from the home kit node.

We go into the Home app, on a iPhone or iPad, and we can see the humidity sensor and temperature sensor are both available when we go add sensor.  So it is as simple as setting it up.  Now, for the humidity sensor, enter a code.  And there we go, the humidity sensor is added.  Now, if we trigger our door sensor, we see that's still there, and if I go into my flow and instead of waiting 5 minutes, and trigger it manually, and there it is, 61%.  Do the exactly same thing with temperature sensor.  Add accessory.  Temperature sensor, add anyway.  Enter the code.  And there you go, temperature sensor added.  And, it's 23 degrees.






