For the very last part of the project, I've hooked up a relay on to pin 13 on the Raspberry Pi.  And this relay will control an LED strip of lights.  So, I can control it directly from the Home app, by turning it on or off, and I can also have it hooked up to the motion sensor, so that it can be triggered whenever there's movement.

So let's go back to my PIR sensor flow.  And, I've removed my buzzer, as that was just there for testing.  And instead I'm going to drop in a GPIO node for the relay, so this is an output device, and it's on pin 13. So I'll call that one relay.  And now I'm going to set it up so that my PIR sensor feeds directly into that relay, so that whenever that sensor is triggered, the lights will go on.  I'm also going to set up a home kit node for the LED lights. So, configure a new type of accessory for the LED strip, I can give that a custom code, and instead of a sensor, this time it's going to be a lightbulb type of accessory.  Give it a name, and then set up the instance, which is going to be lightbulb, give it a name just LED strip.

So now I want to hook it up to my relay, but I need to check exactly what the message payload that is coming out of the LED strip object. So, I'll just use a debug again to log the message content that's coming from that node.  And then I'll go set up home kit and see what the message payload is.  Ok, so, I've configured my Home app with the LED light, so that I can trigger it.  When I trigger it on, this is what happens in the payload. On field is set to one.  So I'm going to need to set that up with a custom function.  So I'll hook that up to my home kit node, and hook that in to my relay.  In that function, I'm just going to create a message payload, that takes the on property from my home kit node and turns it into a number that will trigger the LED lights to go on by the relay.  So, when I send that message through from the Home app, my LED strip will turn on.

The other thing that I need to do is have the state of the LED lights reflect the fact that they've been turned on or off by the PIR sensor. So, what I'll do, is whenever the PIR sensor triggers, I'll set the state of the LED strip to match.  So, getting the value from the payload of the PIR sensor and mapping that to the on property that gets sent through to the home kit node.  Now when I've deployed that change, whenever I update the LEDs by triggering it through the Home app or by triggering it through the PIR sensor, the state displayed through the Home app is going to match the state of the LED strip.


